name: agent
on:
  schedule:
    - cron: "0 * * * *"        # ä¾‹: æ¯æ­£æ™‚ã€‚æ—¢å­˜ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ
  workflow_dispatch:
    inputs:
      run_mode:
        description: "housekeeping-only / full"
        required: false
        default: "full"

permissions:
  contents: read
  actions: write

concurrency:
  group: agent-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --- å‰æ¤œæŸ»: OpenAIã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒã‚ã‚‹æ™‚ã ã‘æœ¬å‡¦ç†ã‚’è¨±å¯ ---
  preflight:
    runs-on: ubuntu-latest
    outputs:
      ready:   ${{ steps.chk.outputs.ready }}
      missing: ${{ steps.chk.outputs.missing }}
    steps:
      - id: chk
        shell: bash
        env:
          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€™è£œï¼ˆã©ã‚Œã‹1ã¤å…¥ã£ã¦ã„ã‚Œã°OKï¼‰
          OPENAI_A: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_B: ${{ secrets.OPENAI_API_TOKEN }}
          OPENAI_C: ${{ secrets.OPENAI_KEY }}
        run: |
          pick() { [ -n "$1" ] && echo "$1" && return 0 || return 1; }
          OPENAI="$(pick "$OPENAI_A" || pick "$OPENAI_B" || pick "$OPENAI_C" || true)"

          if [ -z "$OPENAI" ]; then
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "missing=OPENAI_API_KEY(or TOKEN/KEY)" >> $GITHUB_OUTPUT
            echo "â­ï¸ Missing: OpenAI secret"
          else
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "âœ… OpenAI secret present."
          fi

  # --- éµãŒç„¡ã„æ™‚ or æ˜ç¤ºçš„ã«housekeepingè¦æ±‚æ™‚ ---
  housekeeping:
    needs: preflight
    if: needs.preflight.outputs.ready == 'false' || github.event.inputs.run_mode == 'housekeeping-only'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ§¹ Run non-secret tasks
        shell: bash
        run: |
          echo "housekeeping-only (no secrets)"
          # ã“ã“ã« READMEæ•´å‚™ / é‡è¤‡ãƒ»ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ / md-lint ç­‰ã‚’é…ç½®ï¼ˆéµä¸è¦ã®ã¿ï¼‰

  # --- æœ¬å‡¦ç†: éµãŒã‚ã‚‹æ™‚ã ã‘å‹•ã‹ã™ã€‚ç§˜å¯†ã¯ãƒã‚¹ã‚¯ã—ã¦ç’°å¢ƒå¤‰æ•°ã¸ ---
  main:
    needs: preflight
    if: needs.preflight.outputs.ready == 'true' && github.event.inputs.run_mode != 'housekeeping-only'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve OpenAI secret safely
        id: resolve
        shell: bash
        env:
          OPENAI_A: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_B: ${{ secrets.OPENAI_API_TOKEN }}
          OPENAI_C: ${{ secrets.OPENAI_KEY }}
        run: |
          set -euo pipefail
          pick() { [ -n "$1" ] && echo "$1" && return 0 || return 1; }
          OPENAI="$(pick "$OPENAI_A" || pick "$OPENAI_B" || pick "$OPENAI_C" || true)"
          if [ -z "$OPENAI" ]; then echo "missing OpenAI secret"; exit 1; fi
          echo "::add-mask::$OPENAI"
          printf 'OPENAI_API_KEY=%s\n' "$OPENAI" >> "$GITHUB_ENV"

      - name: ğŸš€ Run tasks that require OpenAI
        shell: bash
        run: |
          # ä»¥é™ã¯ $OPENAI_API_KEY ã‚’åˆ©ç”¨ï¼ˆçµ¶å¯¾ã«echoã—ãªã„ï¼‰
          echo "full run started"
          # å®Ÿå‡¦ç†ã‚’ã“ã“ã¸

